<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Myanmar Lunar Calendar</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Padauk:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Light Theme Defaults */
            --body-bg-gradient-start: #fdf9e0;
            --body-bg-gradient-end: #ffe0b2;
            --text-color: #333;
            --calendar-bg: #fff;
            --header-title-color: #8b0000;
            --dropdown-bg: #f9f9f9;
            --dropdown-border: #ccc;
            --dropdown-text-color: #555;
            --nav-button-color: #666;
            --nav-button-hover-color: #8b0000;
            --weekday-header-bg: #f0f0f0;
            --weekday-header-text: #666;
            --date-cell-shadow: rgba(0,0,0,0.05);
            --date-cell-hover-bg: rgba(255, 255, 255, 0.5);
            --date-cell-hover-border: #c0c0c0;
            --empty-cell-bg: #f8f8f8;
            --empty-cell-border: #e9e9e9;
            --gregorian-day-color: #333;
            --myanmar-date-color: #666;
            --weekend-text-color: #d32f2f;
            --weekend-header-bg: #fce4ec;
            --sabbath-bg: #ffebee;
            --sabbath-border: #ef9a9a;
            --full-moon-bg: #fffde7;
            --full-moon-border: #ffee58;
            --dark-moon-bg: #eceff1;
            --dark-moon-border: #b0bec5;
            --today-border: #3b82f6;
            --today-shadow: rgba(59, 130, 246, 0.2);
            --note-indicator-color: #4CAF50;
            --notification-indicator-color: #3b82f6;
            --moon-icon-color: #FFD700;
            --dark-moon-icon-color: #666;

            /* Milestone Colors */
            --milestone-bg: #ede7f6; /* Light Purple */
            --milestone-border: #9575cd; /* Medium Purple */
            --milestone-text-color: #512da8; /* Dark Purple */

            /* Holiday Colors */
            --holiday-bg: #e0f2f7; /* Light Teal */
            --holiday-border: #4db6ac; /* Medium Teal */
            --holiday-text-color: #00796b; /* Dark Teal */

            /* Modal Colors */
            --modal-overlay-bg: rgba(0, 0, 0, 0.6);
            --modal-bg: white;
            --modal-shadow: rgba(0, 0, 0, 0.2);
            --modal-header-color: #8b0000;
            --modal-close-btn-color: #666;
            --modal-close-btn-hover-color: #333;
            --modal-text-color: #555;
            --textarea-border: #ccc;
            --textarea-focus-border: #3b82f6;
            --textarea-focus-shadow: rgba(59, 130, 246, 0.2);
            --checkbox-accent-color: #3b82f6;
            --save-button-bg: #4CAF50;
            --save-button-hover-bg: #45a049;
            --cancel-button-bg: #f44336;
            --cancel-button-hover-bg: #da190b;
        }

        body.dark-theme {
            --body-bg-gradient-start: #1a2a3a;
            --body-bg-gradient-end: #2a3a4a;
            --text-color: #e0e0e0;
            --calendar-bg: #2b3e50; /* Darker blue-grey */
            --header-title-color: #f0f0f0; /* White */
            --dropdown-bg: #3a4a5a;
            --dropdown-border: #555;
            --dropdown-text-color: #e0e0e0;
            --nav-button-color: #a0a0a0;
            --nav-button-hover-color: #f0f0f0;
            --weekday-header-bg: #3a4a5a;
            --weekday-header-text: #b0b0b0;
            --date-cell-shadow: rgba(0,0,0,0.2);
            --date-cell-hover-bg: rgba(255, 255, 255, 0.1);
            --date-cell-hover-border: #555;
            --empty-cell-bg: #3a4a5a;
            --empty-cell-border: #444;
            --gregorian-day-color: #e0e0e0;
            --myanmar-date-color: #b0b0b0;
            --weekend-text-color: #ff8a80; /* Lighter red */
            --weekend-header-bg: #4a3a3a; /* Darker red background */
            --sabbath-bg: #4a3a3a; /* Darker red */
            --sabbath-border: #ff8a80; /* Lighter red border */
            --full-moon-bg: #4a4a3a; /* Darker yellow */
            --full-moon-border: #ffff8d; /* Lighter yellow border */
            --dark-moon-bg: #3a3a4a; /* Darker grey */
            --dark-moon-border: #a0a0a0; /* Lighter grey border */
            --today-border: #64b5f6; /* Lighter blue */
            --today-shadow: rgba(100, 181, 246, 0.3);
            --note-indicator-color: #81c784;
            --notification-indicator-color: #64b5f6;
            --moon-icon-color: #ffff8d;
            --dark-moon-icon-color: #b0b0b0;

            /* Milestone Colors for Dark Theme */
            --milestone-bg: #3f51b5; /* Darker Blue-Purple */
            --milestone-border: #7986cb; /* Lighter Blue-Purple */
            --milestone-text-color: #e8eaf6; /* Very light blue-purple */

            /* Holiday Colors for Dark Theme */
            --holiday-bg: #263238; /* Darker Blue-Grey */
            --holiday-border: #607d8b; /* Medium Blue-Grey */
            --holiday-text-color: #b0bec5; /* Light Blue-Grey */

            /* Modal Colors for Dark Theme */
            --modal-overlay-bg: rgba(0, 0, 0, 0.8);
            --modal-bg: #3a4a5a;
            --modal-shadow: rgba(0, 0, 0, 0.4);
            --modal-header-color: #f0f0f0;
            --modal-close-btn-color: #b0b0b0;
            --modal-close-btn-hover-color: #f0f0f0;
            --modal-text-color: #e0e0e0;
            --textarea-border: #555;
            --textarea-focus-border: #64b5f6;
            --textarea-focus-shadow: rgba(100, 181, 246, 0.3);
            --checkbox-accent-color: #64b5f6;
            --save-button-bg: #66bb6a;
            --save-button-hover-bg: #4CAF50;
            --cancel-button-bg: #ef5350;
            --cancel-button-hover-bg: #f44336;
        }

        /* Base Styles */
        body {
            font-family: 'Inter', 'Padauk', sans-serif; /* Prioritize Padauk for Myanmar text */
            background: linear-gradient(to bottom right, var(--body-bg-gradient-start), var(--body-bg-gradient-end));
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to the top */
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* Calendar Container */
        .calendar-container {
            background-color: var(--calendar-bg);
            border-radius: 12px;
            box-shadow: 0 8px 24px var(--date-cell-shadow);
            padding: 20px;
            max-width: 800px;
            width: 100%;
            box-sizing: border-box;
            margin-top: 0px; /* Push down slightly from the very top */
            transition: all 0.3s ease-in-out;
        }

        /* Header Section */
        .calendar-header {
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            align-items: center;
            margin-bottom: 25px;
            gap: 15px;
        }

        .calendar-header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--header-title-color);
            margin: 0;
            text-align: center;
            width: 100%; /* Take full width */
        }

        .month-navigation {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%; /* Take full width */
            justify-content: center; /* Center navigation elements */
        }

        .nav-button {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--nav-button-color);
            cursor: pointer;
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
            padding: 5px;
        }

        .nav-button:hover {
            color: var(--nav-button-hover-color);
            transform: scale(1.1);
        }

        .dropdown-group {
            display: flex;
            gap: 10px;
            flex-grow: 1; /* Allow dropdowns to take space */
            justify-content: center; /* Center dropdowns */
        }

        .dropdown-group select {
            padding: 10px 15px;
            border: 1px solid var(--dropdown-border);
            border-radius: 8px;
            background-color: var(--dropdown-bg);
            font-size: 1rem;
            color: var(--dropdown-text-color);
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            -webkit-appearance: none; /* Remove default arrow on select */
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13%205.7L146.2%20200.4%2018.4%2075.1a17.6%2017.6%200%200%200-25.3%2023.3l130.8%20125.9c6.6%206.4%2014.8%209.7%2023.3%209.7s16.7-3.1%2023.3-9.7L287%2092.7c1.5-1.5%202.7-3.2%203.6-5.1.9-1.9%201.4-3.9%201.4-6.1s-.5-4.2-1.4-6.1c-.9-1.9-2.1-3.6-3.6-5.1z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px auto;
            padding-right: 30px; /* Make space for the arrow */
        }

        .dropdown-group select:hover {
            border-color: var(--nav-button-color);
        }

        .dropdown-group select:focus {
            border-color: var(--header-title-color);
            box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.2);
        }

        #myanmar-era-months {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dropdown-text-color);
            text-align: center;
            width: 100%;
        }

        .notification-toggles {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--dropdown-text-color);
            text-align: right;
            width: 100%; /* Take full width */
            align-items: center; /* Center toggles */
        }

        .notification-toggles label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .theme-toggles {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
            width: 100%;
        }

        .theme-button {
            padding: 8px 15px;
            border: 1px solid var(--dropdown-border);
            border-radius: 8px;
            background-color: var(--dropdown-bg);
            color: var(--dropdown-text-color);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        .theme-button:hover {
            border-color: var(--nav-button-color);
        }

        .theme-button.active {
            background-color: var(--header-title-color);
            color: white;
            border-color: var(--header-title-color);
        }

        /* Weekday Headers */
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;         
            margin-bottom: 10px;
        }

        .weekday-name {
            text-align: center;
            font-weight: 600;
            padding: 8px 0;
            background-color: var(--weekday-header-bg);
            border-radius: 6px;
            color: var(--weekday-header-text);
            font-size: 0.95rem;
        }

        /* Red Weekends */
        .weekday-name.weekend {
            color: var(--weekend-text-color);
            background-color: var(--weekend-header-bg);
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            padding: 5px; /* Padding inside the grid */
        }

        /* Date Cell Styling */
        .date-cell {
            border-radius: 8px;
            padding: 20px 10px 15px 10px; /* Increased top padding, adjusted others */
            min-height: 120px; /* Increased min-height */
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            position: relative;
            overflow: hidden;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 1px 3px var(--date-cell-shadow);
        }

        .date-cell:hover {
            background-color: var(--date-cell-hover-bg);
            border: 1px solid var(--date-cell-hover-border);
        }

        .date-cell.empty {
            background-color: var(--empty-cell-bg);
            border: 1px dashed var(--empty-cell-border);
            visibility: hidden;
            cursor: default;
        }

        .gregorian-day {
            font-size: 1.7rem; /* Slightly reduced size for better fit */
            font-weight: 700; /* Maintained weight */
            color: var(--gregorian-day-color);
            margin-bottom: 5px;
            align-self: flex-end;
            position: absolute;
            top: 8px;
            right: 10px;
            z-index: 1;
        }

        .myanmar-date {
            font-size: 1.1rem; /* Slightly reduced size for better fit */
            font-weight: 600; /* Maintained weight */
            line-height: 1.3;
            color: var(--myanmar-date-color);
            margin-top: auto; /* Pushes content to bottom */
            text-align: center;
            width: 100%;
            padding-top: 30px; /* Increased padding-top to clear top elements */
            z-index: 0;
        }

        /* Red Weekend Dates */
        .date-cell.weekend .gregorian-day,
        .date-cell.weekend .myanmar-date {
            color: var(--weekend-text-color);
        }

        /* Special Day Highlights */
        .date-cell.sabbath {
            background-color: var(--sabbath-bg);
            border: 1px solid var(--sabbath-border);
        }

        .date-cell.sabbath .gregorian-day,
        .date-cell.sabbath .myanmar-date {
            color: var(--weekend-text-color);
        }

        .date-cell.full-moon {
            background-color: var(--full-moon-bg);
            border: 1px solid var(--full-moon-border);
        }

        .date-cell.dark-moon {
            background-color: var(--dark-moon-bg);
            border: 1px solid var(--dark-moon-border);
        }

        /* Today's Highlight */
        .date-cell.today {
            border: 2px solid var(--today-border);
            box-shadow: 0 0 0 3px var(--today-shadow);
        }

        /* Milestone Highlight */
        .date-cell.milestone {
            background-color: var(--milestone-bg);
            border: 1px solid var(--milestone-border);
        }
        .date-cell.milestone .gregorian-day,
        .date-cell.milestone .myanmar-date {
            color: var(--milestone-text-color);
        }

        /* Holiday Highlight */
        .date-cell.holiday {
            background-color: var(--holiday-bg);
            border: 1px solid var(--holiday-border);
        }
        .date-cell.holiday .gregorian-day,
        .date-cell.holiday .myanmar-date {
            color: var(--holiday-text-color);
        }


        /* Note Indicator */
        .date-cell .note-indicator {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background-color: var(--note-indicator-color);
            border-radius: 50%;
            display: none; /* Hidden by default */
        }

        .date-cell.has-note .note-indicator {
            display: block; /* Show if has note */
        }

        /* Notification Indicator */
        .date-cell .notification-indicator {
            position: absolute;
            bottom: 5px;
            left: 5px;
            color: var(--notification-indicator-color);
            font-size: 0.8rem;
            display: none; /* Hidden by default */
        }

        .date-cell.has-notification .notification-indicator {
            display: block; /* Show if has notification */
        }

        /* Moon Phase Icons */
        .date-cell .moon-icon {
            position: absolute;
            top: 30px; /* Aligns with the start of Myanmar date content */
            left: 5px;
            font-size: 0.9rem; /* Slightly reduced size for better fit */
            color: var(--moon-icon-color);
            z-index: 1;
        }

        .date-cell.dark-moon .moon-icon {
            color: var(--dark-moon-icon-color);
        }


        /* --- Modal Dialog Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--modal-bg);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px var(--modal-shadow);
            text-align: center;
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--modal-header-color);
            margin: 0;
            display: flex; /* Allow content inside h2 to align */
            align-items: center;
            gap: 10px; /* Space between text and icon */
        }

        .modal-header .ninja-icon {
            font-size: 1.5rem; /* Size of the ninja icon */
            color: var(--header-title-color);
            animation: none; /* Reset animation on initial render */
        }

        .modal-header .ninja-icon.animate {
            animation: ninja-turn 0.8s ease-out forwards;
        }

        @keyframes ninja-turn {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
            100% { transform: rotateY(360deg); }
        }


        .modal-close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--modal-close-btn-color);
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }

        .modal-close-btn:hover {
            color: var(--modal-close-btn-hover-color);
        }

        .modal-body p {
            font-size: 1.1rem;
            color: var(--modal-text-color);
            text-align: left;
            margin-bottom: 10px;
        }

        .modal-body .milestone-text,
        .modal-body .holiday-text { /* Combined styles for consistency */
            font-weight: 700;
            color: var(--milestone-text-color); /* Default to milestone text color */
            margin-top: 10px;
            padding: 8px 12px;
            background-color: var(--milestone-bg); /* Default to milestone background */
            border-radius: 8px;
            border: 1px solid var(--milestone-border); /* Default to milestone border */
        }

        /* Specific style for holiday text in modal */
        .modal-body .holiday-text {
            color: var(--holiday-text-color);
            background-color: var(--holiday-bg);
            border-color: var(--holiday-border);
        }


        .modal-body textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 1px solid var(--textarea-border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Inter', 'Padauk', sans-serif;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: var(--dropdown-bg); /* Use dropdown background for textarea */
            color: var(--dropdown-text-color);
        }

        .modal-body textarea:focus {
            border-color: var(--textarea-focus-border);
            box-shadow: 0 0 0 3px var(--textarea-focus-shadow);
        }

        .modal-body .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            justify-content: flex-start;
        }

        .modal-body .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--checkbox-accent-color);
            cursor: pointer;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        .modal-button.save {
            background-color: var(--save-button-bg);
            color: white;
            border: none;
        }

        .modal-button.save:hover {
            background-color: var(--save-button-hover-bg);
        }

        .modal-button.cancel {
            background-color: var(--cancel-button-bg);
            color: white;
            border: none;
        }

        .modal-button.cancel:hover {
            background-color: var(--cancel-button-hover-bg);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .calendar-container {
                padding: 15px;
            }

            .calendar-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .calendar-header h1 {
                font-size: 1.8rem;
            }

            .dropdown-group {
                flex-direction: column;
                width: 100%;
            }

            .dropdown-group select {
                width: 100%;
            }

            .notification-toggles {
                flex-direction: row;
                justify-content: center;
                width: 100%;
                gap: 20px;
                margin-top: 10px;
            }

            .weekday-name {
                font-size: 0.9rem;
            }

            .date-cell {
                min-height: 100px; /* Adjusted for mobile */
                padding: 15px 8px 10px 8px; /* Adjusted padding for mobile */
            }

            .gregorian-day {
                font-size: 1.4rem; /* Adjusted for mobile */
                top: 5px;
                right: 5px;
            }

            .myanmar-date {
                font-size: 1rem; /* Adjusted for mobile */
                padding-top: 25px; /* Adjusted padding-top for mobile */
            }

            .moon-icon {
                font-size: 0.9rem; /* Adjusted for mobile */
            }

            .modal-content {
                padding: 1.5rem;
            }

            .modal-header h2 {
                font-size: 1.5rem;
            }
            .modal-header .ninja-icon {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 480px) {
            .calendar-container {
                padding: 10px;
            }

            .calendar-header h1 {
                font-size: 1.5rem;
            }

            .date-cell {
                min-height: 90px; /* Adjusted for mobile */
                padding: 10px 5px 8px 5px; /* Adjusted padding for mobile */
            }

            .gregorian-day {
                font-size: 1.2rem;
                top: 5px;
                right: 5px;
            }

            .myanmar-date {
                font-size: 0.9rem;
                padding-top: 20px;
            }

            .moon-icon {
                font-size: 0.8rem; /* Further reduced for very small screens */
            }
            .modal-header .ninja-icon {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <div class="calendar-header">
            <h1>Myanmar Lunar Calendar</h1>
            <div class="month-navigation">
                <button id="prev-month-btn" class="nav-button"><i class="fas fa-chevron-left"></i></button>
                <div class="dropdown-group">
                    <select id="year-select"></select>
                    <select id="month-select"></select>
                </div>
                <button id="next-month-btn" class="nav-button"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div id="myanmar-era-months"></div> <div class="notification-toggles">
                <label>
                    <input type="checkbox" id="global-notify-toggle">
                    Enable Notifications
                </label>
                <label>
                    <input type="checkbox" id="voice-notify-toggle">
                    Enable Voice Alerts
                </label>
            </div>
            <div class="theme-toggles">
                <button id="light-theme-btn" class="theme-button">Light Theme</button>
                <button id="dark-theme-btn" class="theme-button">Dark Theme</button>
            </div>
        </div>

        <div class="weekdays">
            <div class="weekday-name">Sun</div>
            <div class="weekday-name">Mon</div>
            <div class="weekday-name">Tue</div>
            <div class="weekday-name">Wed</div>
            <div class="weekday-name">Thu</div>
            <div class="weekday-name">Fri</div>
            <div class="weekday-name">Sat</div>
        </div>

        <div id="calendar-grid" class="calendar-grid">
            </div>
    </div>

    <div id="day-dialog-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="dialog-gregorian-date">
                    <i class="fas fa-user-ninja ninja-icon"></i> </h2>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p id="dialog-myanmar-date"></p>
                <p id="dialog-special-days"></p>
                <p id="dialog-milestone-text" class="milestone-text" style="display: none;"></p> <p id="dialog-holiday-text" class="holiday-text" style="display: none;"></p> <h3>Notes:</h3>
                <textarea id="dialog-note-textarea" placeholder="Write your notes here..."></textarea>
                <div class="checkbox-group">
                    <input type="checkbox" id="dialog-notify-toggle">
                    <label for="dialog-notify-toggle">Enable Notification for This Day</label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-note-btn" class="modal-button save">Save</button>
                <button id="cancel-note-btn" class="modal-button cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- Myanmar Calendar Data (Simplified for demonstration) ---
        const MYANMAR_MONTHS = [
            "တန်ခူး", "ကဆုန်", "နယုန်", "ဝါဆို", "ဝါခေါင်", "တော်သလင်း",
            "သီတင်းကျွတ်", "တန်ဆောင်မုန်း", "နတ်တော်", "ပြာသို", "တပို့တွဲ", "တပေါင်း"
        ];
        const ENGLISH_WEEKDAYS = [
            "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"
        ];
        const MYANMAR_WEEKDAYS = [
            "တနင်္ဂနွေ", "တနင်္လာ", "အင်္ဂါ", "ဗုဒ္ဓဟူး", "ကြာသပတေး", "သောကြာ", "စနေ"
        ];
        // Myanmar month abbreviations for "Ba Nya" style (last two characters)
        // This is a simplified approach. Some months might not strictly follow this.
        const MYANMAR_MONTH_ABBR = {
            "တန်ခူး": "ခူး", "ကဆုန်": "ဆုန်", "နယုန်": "ယုန်", "ဝါဆို": "ဆို",
            "ဝါခေါင်": "ခေါင်", "တော်သလင်း": "လင်း", "သီတင်းကျွတ်": "ကျွတ်",
            "တန်ဆောင်မုန်း": "မုန်း", "နတ်တော်": "တော်", "ပြာသို": "သို",
            "တပို့တွဲ": "တွဲ", "တပေါင်း": "ပေါင်း"
        };

        // Approximate lunar day offset for the 1st of each Gregorian month (0-indexed)
        // This array is manually tuned to make the approximate lunar day calculation more consistent
        // and specifically to make 1 May 2025 (Kason) work as "ကဆုန် ၅ လဆန်း ရက်".
        // Values represent the approximate lunar day number (1-15 waxing, 1-15 waning).
        // A value of 1 means Gregorian Day 1 is approx. 1st waxing.
        // A value of 16 means Gregorian Day 1 is approx. 1st waning.
        // This array attempts to set the "starting lunar day" for the 1st of each Gregorian month.
        const LUNAR_DAY_OFFSET_FOR_GREGORIAN_MONTH_START = [
            16, // Jan (Pyatho): Approx 1st waning
            1,  // Feb (Tabaung): Approx 1st waxing
            16, // Mar (Tagu): Approx 1st waning
            1,  // Apr (Kason): Approx 1st waxing
            5,  // May (Nayon, but for 1 May 2025 it's Kason): Adjusted to make 1 May = Kason La San 5.
                // If May 1st is La San 5, then the new moon of Kason was April 27.
                // So, for May 1st, the lunar day is 5.
                // This means the offset for May (month 4) is 5.
            16, // Jun (Waso): Approx 1st waning
            1,  // Jul (Wagaung): Approx 1st waxing
            16, // Aug (Tawthalin): Approx 1st waning
            1,  // Sep (Thadingyut): Approx 1st waxing
            16, // Oct (Tazaungmon): Approx 1st waning
            1,  // Nov (Natdaw): Approx 1st waxing
            16  // Dec (Pyatho): Approx 1st waning
        ];

        // --- Milestone Data (Hardcoded for demonstration) ---
        const MILESTONES = {
            "2025-01-15": "New Year's Resolution Check-in!",
            "2025-02-20": "Project Alpha Launch Date",
            "2025-03-08": "International Women's Day",
            "2025-06-05": "Mid-Year Review",
            "2025-07-25": "Important Client Meeting",
            "2025-08-10": "Team Building Event",
            "2025-09-01": "Academic Year Starts",
            "2025-11-15": "Diwali Celebration",
            "2025-12-25": "Christmas Day"
        };

        // --- Holiday Data (Hardcoded for demonstration) ---
        // Includes both English and Burmese names
        const HOLIDAYS = {
            "2025-01-01": "New Year's Day (နှစ်သစ်ကူးနေ့)",
            "2025-01-04": "Independence Day (လွတ်လပ်ရေးနေ့)",
            "2025-02-12": "Union Day (ပြည်ထောင်စုနေ့)",
            "2025-02-13": "General Aung San's Birthday (ဗိုလ်ချုပ်အောင်ဆန်းမွေးနေ့)",
            "2025-03-02": "Peasants' Day (တောင်သူလယ်သမားနေ့)",
            "2025-03-27": "Armed Forces' Day (တပ်မတော်နေ့)",
            "2025-04-13": "Thingyan A-Kyo Nei (သင်္ကြန်အကြိုနေ့)", // First day of Thingyan
            "2025-04-14": "Thingyan A-Kyar Nei (သင်္ကြန်အကျနေ့)", // Second day of Thingyan
            "2025-04-15": "Thingyan A-Htat Nei (သင်္ကြန်အတက်နေ့)", // Third day of Thingyan
            "2025-04-16": "Thingyan A-Htat Nei (သင်္ကြန်အတက်နေ့)", // Fourth day of Thingyan (Often 2 days)
            "2025-04-17": "Myanmar New Year's Day (မြန်မာနှစ်ဆန်းတစ်ရက်နေ့)", // New Year
            "2025-05-01": "Labour Day (အလုပ်သမားနေ့)",
            "2025-05-01": "Kason Full Moon Day (ကဆုန်လပြည့်နေ့)", // Explicitly marking Kason Full Moon as a holiday for 2025
            "2025-07-19": "Martyrs' Day (အာဇာနည်နေ့)",
            "2025-10-16": "Thadingyut Full Moon Day (သီတင်းကျွတ်လပြည့်နေ့)", // Approximate for 2025
            "2025-11-14": "Tazaungmon Full Moon Day (တန်ဆောင်မုန်းလပြည့်နေ့)", // Approximate for 2025
            "2025-12-02": "National Day (အမျိုးသားနေ့)",
            "2025-12-25": "Christmas Day (ခရစ္စမတ်နေ့)"
        };


        /**
         * Function to convert Gregorian date to Myanmar lunar date (Simplified Approximation).
         * This is NOT astronomically accurate but aims for a more logical display progression
         * of waxing/waning/full/dark moon phases and approximate Myanmar month.
         * @param {Date} gregorianDate The Gregorian Date object.
         * @returns {{myanmarDate: string, isUposatha: boolean, isFullMoon: boolean, isDarkMoon: boolean, moonPhaseIcon: string}}
         */
        function getMyanmarLunarDate(gregorianDate) {
            const day = gregorianDate.getDate();
            const month = gregorianDate.getMonth(); // 0-11
            const year = gregorianDate.getFullYear();
            const daysInGregorianMonth = new Date(year, month + 1, 0).getDate();

            let lunarDayNum = 0;
            let lunarPhaseText = '';
            let myanmarDateString = ''; // Full Myanmar date string
            let isUposatha = false;
            let isFullMoon = false;
            let isDarkMoon = false;
            let moonPhaseIcon = ''; // Font Awesome icon class

            // Calculate current lunar day number based on Gregorian day and month-specific offset
            // `effectiveLunarDay` attempts to map the Gregorian day to a continuous lunar cycle day.
            let effectiveLunarDay = day + LUNAR_DAY_OFFSET_FOR_GREGORIAN_MONTH_START[month] - 1;

            // Handle wrap-around for a 30-day lunar cycle for this approximation
            lunarDayNum = (effectiveLunarDay - 1) % 30 + 1; // Ensure 1 to 30

            // Determine phase and day number within phase (1-15)
            if (lunarDayNum >= 1 && lunarDayNum <= 15) {
                // Waxing moon phase (လဆန်း) or Full Moon
                if (lunarDayNum === 15) { // 15th Waxing is Full Moon
                    lunarPhaseText = `လပြည့်`;
                    isFullMoon = true;
                    isUposatha = true;
                    moonPhaseIcon = 'fas fa-circle'; // Full circle for full moon
                } else {
                    lunarPhaseText = `${convertToMyanmarNumeral(lunarDayNum)} လဆန်း`; // Waxing
                    if (lunarDayNum === 8) isUposatha = true; // 8th Waxing Uposatha
                    // No icon for waxing moon as per request
                }
            } else { // lunarDayNum >= 16 && lunarDayNum <= 30
                // Waning moon phase (လဆုတ်) or Dark Moon
                lunarDayNum = lunarDayNum - 15; // Convert 16-30 to 1-15 for waning day count
                if (lunarDayNum === 15) { // 30th lunar day is Dark Moon (15th waning)
                    lunarPhaseText = `လကွယ်`;
                    isDarkMoon = true;
                    isUposatha = true;
                    moonPhaseIcon = 'far fa-circle'; // Empty circle for dark moon
                } else {
                    lunarPhaseText = `${convertToMyanmarNumeral(lunarDayNum)} လဆုတ်`; // Waning
                    if (lunarDayNum === 8) isUposatha = true; // 8th Waning Uposatha
                    // No icon for waning moon as per request
                }
            }

            // Approximate Myanmar month based on Gregorian month.
            // This mapping is very rough and depends on the specific year and lunar rules.
            // Myanmar new year (Thingyan) is usually in April (Tagu/Kason).
            // This offset aims to align Gregorian months roughly to Myanmar lunar months.
            // Example: Jan (0) -> Pyatho (9), Feb (1) -> Tabaung (10), Mar (2) -> Tagu (11), Apr (3) -> Kason (0), May (4) -> Nayon (1)
            let myanmarMonthIndex = (month + 9) % 12;
            const myanmarMonthName = MYANMAR_MONTHS[myanmarMonthIndex];

            // Construct the full Myanmar date string
            if (isFullMoon || isDarkMoon) {
                myanmarDateString = `${myanmarMonthName} ${lunarPhaseText}`;
            } else {
                myanmarDateString = `${myanmarMonthName} ${lunarPhaseText} ရက်`;
            }

            return {
                myanmarDate: myanmarDateString,
                isUposatha: isUposatha,
                isFullMoon: isFullMoon,
                isDarkMoon: isDarkMoon,
                moonPhaseIcon: moonPhaseIcon
            };
        }

        /**
         * Converts Western numerals to Myanmar numerals.
         * @param {number} number The number to convert.
         * @returns {string} The number in Myanmar numerals.
         */
        function convertToMyanmarNumeral(number) {
            const myanmarNumerals = ['၀', '၁', '၂', '၃', '၄', '၅', '၆', '၇', '၈', '၉'];
            return String(number).split('').map(digit => myanmarNumerals[parseInt(digit)]).join('');
        }

        /**
         * Converts Gregorian day of week (0-6) to Myanmar weekday name.
         * @param {number} dayOfWeek The Gregorian day of week (0 for Sunday).
         * @returns {string} The Myanmar weekday name.
         */
        function getMyanmarWeekday(dayOfWeek) {
            return MYANMAR_WEEKDAYS[dayOfWeek];
        }

        /**
         * Calculates and formats the Myanmar Era year and approximate lunar month range.
         * @param {number} gregorianYear The Gregorian year.
         * @param {number} gregorianMonth The Gregorian month (0-11).
         * @returns {string} Formatted string like "1385 ပြာသို - တပို့တွဲ သို တွဲ".
         */
        function getMyanmarEraAndMonths(gregorianYear, gregorianMonth) {
            // Approximate Myanmar Era year (Thingyan usually in April, so offset depends)
            // This is a common approximation.
            let myanmarEraYear = gregorianYear - 638;

            // Determine Myanmar month for the start of the Gregorian month
            const startOfMonthGregorianDate = new Date(gregorianYear, gregorianMonth, 1);
            const startMyanmarMonthName = getMyanmarLunarDate(startOfMonthGregorianDate).myanmarDate.split(' ')[0];

            // Determine Myanmar month for the end of the Gregorian month
            const endOfMonthGregorianDate = new Date(gregorianYear, gregorianMonth + 1, 0);
            const endMyanmarMonthName = getMyanmarLunarDate(endOfMonthGregorianDate).myanmarDate.split(' ')[0];

            let monthRangeText = '';
            let abbrText = '';

            // Handle cases where Gregorian month spans one or two Myanmar months
            if (startMyanmarMonthName === endMyanmarMonthName) {
                monthRangeText = startMyanmarMonthName;
                abbrText = MYANMAR_MONTH_ABBR[startMyanmarMonthName] || '';
            } else {
                monthRangeText = `${startMyanmarMonthName} - ${endMyanmarMonthName}`;
                const startAbbr = MYANMAR_MONTH_ABBR[startMyanmarMonthName] || '';
                const endAbbr = MYANMAR_MONTH_ABBR[endMyanmarMonthName] || '';
                abbrText = `${startAbbr} ${endAbbr}`;
            }

            return `${convertToMyanmarNumeral(myanmarEraYear)} ${monthRangeText} ${abbrText}`;
        }


        // --- Calendar Rendering Logic ---
        const yearSelect = document.getElementById('year-select');
        const monthSelect = document.getElementById('month-select');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const calendarGrid = document.getElementById('calendar-grid');
        const globalNotifyToggle = document.getElementById('global-notify-toggle');
        const voiceNotifyToggle = document.getElementById('voice-notify-toggle');
        const myanmarEraMonthsEl = document.getElementById('myanmar-era-months'); // Get the new div
        const lightThemeBtn = document.getElementById('light-theme-btn');
        const darkThemeBtn = document.getElementById('dark-theme-btn');


        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth(); // 0-indexed

        // Populate Year Dropdown (1900-2200)
        for (let i = 1900; i <= 2200; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            if (i === currentYear) {
                option.selected = true;
            }
            yearSelect.appendChild(option);
        }

        // Populate Month Dropdown
        const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        monthNames.forEach((name, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = name;
            if (index === currentMonth) {
                option.selected = true;
            }
            monthSelect.appendChild(option);
        });

        /**
         * Navigates to the previous month.
         */
        function goToPrevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            yearSelect.value = currentYear;
            monthSelect.value = currentMonth;
            generateCalendar();
        }

        /**
         * Navigates to the next month.
         */
        function goToNextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            yearSelect.value = currentYear;
            monthSelect.value = currentMonth;
            generateCalendar();
        }

        /**
         * Generates and displays the calendar for the selected year and month.
         */
        function generateCalendar() {
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);

            // Update currentYear and currentMonth based on dropdowns
            currentYear = year;
            currentMonth = month;

            calendarGrid.innerHTML = ''; // Clear previous calendar

            // Update Myanmar Era and Months in header
            myanmarEraMonthsEl.textContent = getMyanmarEraAndMonths(currentYear, currentMonth);

            // Update weekday names for Sunday and Saturday to be red
            const weekdayNames = document.querySelectorAll('.weekday-name');
            weekdayNames.forEach((el, index) => {
                if (index === 0 || index === 6) { // Sunday (0) and Saturday (6)
                    el.classList.add('weekend');
                } else {
                    el.classList.remove('weekend');
                }
            });

            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.

            // Add empty cells for days before the 1st of the month
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('date-cell', 'empty');
                calendarGrid.appendChild(emptyCell);
            }

            // Add date cells for each day of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateCell = document.createElement('div');
                dateCell.classList.add('date-cell');

                const gregorianDate = new Date(year, month, day);
                const myanmarLunarInfo = getMyanmarLunarDate(gregorianDate);
                const dayOfWeek = gregorianDate.getDay(); // 0-6

                // Add weekend class for Saturday and Sunday
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    dateCell.classList.add('weekend');
                }

                // Add special day classes (Uposatha, Full Moon, Dark Moon)
                if (myanmarLunarInfo.isUposatha) {
                    dateCell.classList.add('sabbath');
                }
                if (myanmarLunarInfo.isFullMoon) {
                    dateCell.classList.add('full-moon');
                }
                if (myanmarLunarInfo.isDarkMoon) {
                    dateCell.classList.add('dark-moon');
                }

                // Check for milestones
                const dateString = formatDateForStorage(gregorianDate);
                if (MILESTONES[dateString]) {
                    dateCell.classList.add('milestone');
                }

                // Check for holidays
                if (HOLIDAYS[dateString]) {
                    dateCell.classList.add('holiday');
                }

                // Highlight today's date
                if (gregorianDate.toDateString() === today.toDateString()) {
                    dateCell.classList.add('today');
                }

                // Check for existing notes and notifications
                const storedData = JSON.parse(localStorage.getItem(dateString));

                if (storedData && storedData.note) {
                    dateCell.classList.add('has-note');
                }
                if (storedData && storedData.notify) {
                    dateCell.classList.add('has-notification');
                }

                dateCell.innerHTML = `
                    <div class="gregorian-day">${day}</div>
                    <div class="myanmar-date">
                        ${myanmarLunarInfo.moonPhaseIcon ? `<i class="${myanmarLunarInfo.moonPhaseIcon} moon-icon"></i>` : ''}
                        ${myanmarLunarInfo.myanmarDate}
                    </div>
                    <div class="note-indicator"></div>
                    <div class="notification-indicator"><i class="fas fa-bell"></i></div>
                `;
                dateCell.dataset.gregorianDate = gregorianDate.toISOString(); // Store date for dialog
                calendarGrid.appendChild(dateCell);
            }

            // Attach click listeners to date cells
            document.querySelectorAll('.date-cell:not(.empty)').forEach(cell => {
                cell.addEventListener('click', () => {
                    const dateISOString = cell.dataset.gregorianDate;
                    showDayDialog(new Date(dateISOString));
                });
            });

            // After generating the calendar, check for notifications for today
            checkAndTriggerNotifications();
        }

        // --- Dialog Logic ---
        const dialogOverlay = document.getElementById('day-dialog-overlay');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const dialogGregorianDateEl = document.getElementById('dialog-gregorian-date');
        const dialogMyanmarDateEl = document.getElementById('dialog-myanmar-date');
        const dialogSpecialDaysEl = document.getElementById('dialog-special-days');
        const dialogMilestoneTextEl = document.getElementById('dialog-milestone-text'); // New element for milestone text
        const dialogHolidayTextEl = document.getElementById('dialog-holiday-text'); // New element for holiday text
        const dialogNoteTextarea = document.getElementById('dialog-note-textarea');
        const dialogNotifyToggle = document.getElementById('dialog-notify-toggle');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const cancelNoteBtn = document.getElementById('cancel-note-btn');
        const ninjaIcon = document.querySelector('.ninja-icon'); // Get the ninja icon element

        let currentDialogDate = null; // Stores the Date object for the currently open dialog

        /**
         * Formats a Date object into a Jahrhunderts-MM-DD string for localStorage key.
         * @param {Date} date The date object.
         * @returns {string} The formatted date string.
         */
        function formatDateForStorage(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Shows the day dialog with details for the given date.
         * @param {Date} date The Date object for which to show details.
         */
        function showDayDialog(date) {
            currentDialogDate = date; // Store the date for saving notes

            const gregorianDateString = date.toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            const myanmarLunarInfo = getMyanmarLunarDate(date);
            const dayOfWeek = date.getDay();

            // Always ensure ninja icon is present in the H2
            dialogGregorianDateEl.innerHTML = `<i class="fas fa-user-ninja ninja-icon"></i> ${gregorianDateString}`;
            const currentNinjaIcon = dialogGregorianDateEl.querySelector('.ninja-icon');
            if (currentNinjaIcon) {
                currentNinjaIcon.classList.remove('animate'); // Remove to reset animation
                void currentNinjaIcon.offsetWidth; // Trigger reflow
                currentNinjaIcon.classList.add('animate'); // Add to restart animation
            }


            // In dialog, show Myanmar date with weekday for full context
            dialogMyanmarDateEl.textContent = `${myanmarLunarInfo.myanmarDate} (${getMyanmarWeekday(dayOfWeek)})`;

            let specialDaysText = '';
            if (myanmarLunarInfo.isUposatha) {
                specialDaysText += 'ဥပုသ်နေ့ (Uposatha Day)';
            }
            if (myanmarLunarInfo.isFullMoon) {
                specialDaysText += (specialDaysText ? ' | ' : '') + 'လပြည့်နေ့ (Full Moon Day)';
            }
            if (myanmarLunarInfo.isDarkMoon) {
                specialDaysText += (specialDaysText ? ' | ' : '') + 'လကွယ်နေ့ (Dark Moon Day)';
            }
            dialogSpecialDaysEl.textContent = specialDaysText;
            dialogSpecialDaysEl.style.color = specialDaysText.includes('ဥပုသ်နေ့') ? 'var(--weekend-text-color)' : 'var(--modal-text-color)';

            // Display milestone text if available
            const dateString = formatDateForStorage(date);
            const milestoneText = MILESTONES[dateString];
            if (milestoneText) {
                dialogMilestoneTextEl.textContent = `Milestone: ${milestoneText}`;
                dialogMilestoneTextEl.style.display = 'block';
            } else {
                dialogMilestoneTextEl.textContent = '';
                dialogMilestoneTextEl.style.display = 'none';
            }

            // Display holiday text if available
            const holidayText = HOLIDAYS[dateString];
            if (holidayText) {
                dialogHolidayTextEl.textContent = `Holiday: ${holidayText}`;
                dialogHolidayTextEl.style.display = 'block';
            } else {
                dialogHolidayTextEl.textContent = '';
                dialogHolidayTextEl.style.display = 'none';
            }


            // Load note and notification preference from localStorage
            const noteKey = formatDateForStorage(date);
            const storedData = JSON.parse(localStorage.getItem(noteKey));

            dialogNoteTextarea.value = storedData?.note || '';
            dialogNotifyToggle.checked = storedData?.notify || false;

            dialogOverlay.classList.add('show');
        }

        /**
         * Hides the day dialog.
         */
        function hideDayDialog() {
            dialogOverlay.classList.remove('show');
            currentDialogDate = null; // Clear the date
            dialogNoteTextarea.value = ''; // Clear textarea
            dialogNotifyToggle.checked = false; // Reset toggle
            dialogMilestoneTextEl.style.display = 'none'; // Hide milestone text
            dialogHolidayTextEl.style.display = 'none'; // Hide holiday text
        }

        /**
         * Saves the note and notification preference from the dialog to localStorage.
         */
        function saveNote() {
            if (!currentDialogDate) return;

            const noteKey = formatDateForStorage(currentDialogDate);
            const noteText = dialogNoteTextarea.value.trim();
            const notifyEnabled = dialogNotifyToggle.checked;

            const dataToSave = {
                note: noteText,
                notify: notifyEnabled
            };

            if (noteText || notifyEnabled) { // Only save if there's a note or notification is enabled
                localStorage.setItem(noteKey, JSON.stringify(dataToSave));
            } else {
                localStorage.removeItem(noteKey); // Remove if both are empty/disabled
            }

            hideDayDialog();
            generateCalendar(); // Re-render calendar to update note/notification indicators
        }

        // Event Listeners for dialog buttons
        modalCloseBtn.addEventListener('click', hideDayDialog);
        cancelNoteBtn.addEventListener('click', hideDayDialog);
        saveNoteBtn.addEventListener('click', saveNote);

        // Close dialog if clicking outside content
        dialogOverlay.addEventListener('click', (e) => {
            if (e.target === dialogOverlay) {
                hideDayDialog();
            }
        });

        // --- Notification Logic ---

        /**
         * Requests notification permission from the user.
         */
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.warn("This browser does not support desktop notification");
                return;
            }

            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log("Notification permission granted.");
                    } else {
                        console.log("Notification permission denied.");
                        globalNotifyToggle.checked = false; // Uncheck if denied
                        localStorage.setItem('calendarNotificationsEnabled', 'false');
                    }
                });
            } else if (Notification.permission === 'denied') {
                console.warn("Notification permission was denied. Please enable it in your browser settings.");
                // Optionally, inform the user with a message on the UI
            }
        }

        /**
         * Triggers a browser notification.
         * @param {string} title The title of the notification.
         * @param {string} body The body text of the notification.
         */
        function sendNotification(title, body) {
            if (Notification.permission === 'granted' && globalNotifyToggle.checked) {
                new Notification(title, { body: body });
                if (voiceNotifyToggle.checked) {
                    speakNotification(body);
                }
            }
        }

        /**
         * Speaks the notification message using Web Speech API.
         * @param {string} message The message to speak.
         */
        const synth = window.speechSynthesis;
        function speakNotification(message) {
            if (synth && voiceNotifyToggle.checked) {
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.lang = 'en-US'; // You can try 'my-MM' if a Myanmar voice is available
                synth.speak(utterance);
            }
        }

        /**
         * Checks if today's date has a notification set and triggers it if conditions met.
         */
        function checkAndTriggerNotifications() {
            const todayString = formatDateForStorage(today);
            const notifiedTodayFlag = sessionStorage.getItem(`notified_${todayString}`);

            // Only check if global notifications are enabled and we haven't notified today yet
            if (globalNotifyToggle.checked && Notification.permission === 'granted' && !notifiedTodayFlag) {
                const storedData = JSON.parse(localStorage.getItem(todayString));

                if (storedData && storedData.notify) { // Trigger if notification is enabled for today
                    let title = `Myanmar Calendar: Today's Reminder!`;
                    let body = storedData.note || ''; // Use note if available, otherwise general info

                    if (!storedData.note) { // If no specific note, provide general info
                        const myanmarInfo = getMyanmarLunarDate(today);
                        const dayOfWeek = today.getDay();
                        body = `Today is ${myanmarInfo.myanmarDate} (${getMyanmarWeekday(dayOfWeek)}).`;
                        if (myanmarInfo.isUposatha) body += " It's an Uposatha Day!";
                        if (myanmarInfo.isFullMoon) body += " It's a Full Moon Day!";
                        if (myanmarInfo.isDarkMoon) body += " It's a Dark Moon Day!";
                    }

                    // Add holiday/milestone info to notification body if present
                    const holidayInfo = HOLIDAYS[todayString];
                    if (holidayInfo) {
                        body += ` Holiday: ${holidayInfo}.`;
                    }
                    const milestoneInfo = MILESTONES[todayString];
                    if (milestoneInfo) {
                        body += ` Milestone: ${milestoneInfo}.`;
                    }


                    sendNotification(title, body);
                    sessionStorage.setItem(`notified_${todayString}`, 'true'); // Set flag to prevent repeat
                }
            }
        }

        // --- Theme Logic ---
        /**
         * Applies the specified theme to the body.
         * @param {string} themeName 'light-theme' or 'dark-theme'.
         */
        function applyTheme(themeName) {
            document.body.classList.remove('light-theme', 'dark-theme');
            document.body.classList.add(themeName);
            localStorage.setItem('calendarTheme', themeName);

            // Update active state of theme buttons
            lightThemeBtn.classList.remove('active');
            darkThemeBtn.classList.remove('active');
            if (themeName === 'light-theme') {
                lightThemeBtn.classList.add('active');
            } else {
                darkThemeBtn.classList.add('active');
            }
        }

        // --- Global Notification Toggle Event Listeners ---
        globalNotifyToggle.addEventListener('change', () => {
            localStorage.setItem('calendarNotificationsEnabled', globalNotifyToggle.checked);
            if (globalNotifyToggle.checked) {
                requestNotificationPermission();
                checkAndTriggerNotifications(); // Check immediately if just enabled
            }
        });

        voiceNotifyToggle.addEventListener('change', () => {
            localStorage.setItem('calendarVoiceNotificationsEnabled', voiceNotifyToggle.checked);
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load global notification settings
            globalNotifyToggle.checked = localStorage.getItem('calendarNotificationsEnabled') === 'true';
            voiceNotifyToggle.checked = localStorage.getItem('calendarVoiceNotificationsEnabled') === 'true';

            // Load and apply theme
            const savedTheme = localStorage.getItem('calendarTheme') || 'light-theme';
            applyTheme(savedTheme);

            // Initial calendar generation
            generateCalendar();
        });

        // Event Listeners for dropdowns
        yearSelect.addEventListener('change', generateCalendar);
        monthSelect.addEventListener('change', generateCalendar);

        // Event Listeners for month navigation buttons
        prevMonthBtn.addEventListener('click', goToPrevMonth);
        nextMonthBtn.addEventListener('click', goToNextMonth);

        // Event Listeners for theme buttons
        lightThemeBtn.addEventListener('click', () => applyTheme('light-theme'));
        darkThemeBtn.addEventListener('click', () => applyTheme('dark-theme'));
    </script>
</body>
</html>
